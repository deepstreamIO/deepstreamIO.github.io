<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="DeepstreamIO RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="DeepstreamIO Atom Feed"><title data-react-helmet="true">Valve Introduction | DeepstreamIO</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://deepstreamIO.github.io/docs/tutorials/core/permission/valve-introduction"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Valve Introduction | DeepstreamIO"><meta data-react-helmet="true" name="description" content="Learn permissions with Valve"><meta data-react-helmet="true" property="og:description" content="Learn permissions with Valve"><link data-react-helmet="true" rel="icon" href="/img/eltons/elton-hive.svg"><link data-react-helmet="true" rel="canonical" href="https://deepstreamIO.github.io/docs/tutorials/core/permission/valve-introduction"><link data-react-helmet="true" rel="alternate" href="https://deepstreamIO.github.io/docs/tutorials/core/permission/valve-introduction" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://deepstreamIO.github.io/docs/tutorials/core/permission/valve-introduction" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.82963691.css">
<link rel="preload" href="/assets/js/runtime~main.4b67704a.js" as="script">
<link rel="preload" href="/assets/js/main.a9eddb7b.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/eltons/elton-hive.svg" alt="DeepstreamIO" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/img/eltons/elton-hive.svg" alt="DeepstreamIO" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">DeepstreamIO</b></a><a class="navbar__item navbar__link" href="/docs/tutorials/concepts/what-is-deepstream">Tutorials</a><a class="navbar__item navbar__link" href="/docs/docs">Docs</a><a class="navbar__item navbar__link" href="/docs/guides">Guides</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/deepstreamIO" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">ðŸŒœ</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">ðŸŒž</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_TwRn" href="/docs/tutorials/concepts/what-is-deepstream">tutorials</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" tabindex="0" href="/docs/tutorials/concepts/what-is-deepstream">concepts</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" tabindex="0" href="/docs/tutorials/getting-started/javascript">getting-started</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" tabindex="0" href="/docs/tutorials/install/linux">install</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_TwRn" tabindex="0" href="/docs/tutorials/core/auth/auth-introduction">core</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" tabindex="0" href="/docs/tutorials/core/auth/auth-introduction">auth</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_TwRn" tabindex="0" href="/docs/tutorials/core/permission/valve-introduction">permission</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/tutorials/core/permission/valve-introduction">Valve Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tutorials/core/permission/valve-simple">Valve Simple</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tutorials/core/permission/valve-advanced">Valve Advanced</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tutorials/core/permission/valve-dynamic">Valve Dynamic</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tutorials/core/permission/user-specific-data">User-Specific Data</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" tabindex="0" href="/docs/tutorials/core/pubsub/events">pubsub</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" tabindex="0" href="/docs/tutorials/core/request-response/rpc">request-response</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" tabindex="0" href="/docs/tutorials/core/presence/query-clients">presence</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" tabindex="0" href="/docs/tutorials/core/datasync/records">datasync</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" tabindex="0" href="/docs/tutorials/core/listening/index">listening</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" tabindex="0" href="/docs/tutorials/integrations/frontend/react">integrations</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" tabindex="0" href="/docs/tutorials/plugins/logger/std">plugins</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" tabindex="0" href="/docs/tutorials/custom-plugins/an-overview">custom-plugins</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" tabindex="0" href="/docs/tutorials/devops/nginx">devops</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_TwRn" href="/docs/docs">docs</a><button aria-label="Toggle the collapsible sidebar category &#x27;docs&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_TwRn" href="/docs/guides">guides</a><button aria-label="Toggle the collapsible sidebar category &#x27;guides&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Valve Introduction</h1></header><p>deepstream uses a powerful permission-language called Valve that allows you to specify which user can perform which action with which data.</p><p>With Valve you can</p><ul><li>Restrict access for individual users or groups</li><li>Permission individual actions (e.g. write, publish or listen)</li><li>Permission individual records, events or rpcs</li><li>validate incoming data</li><li>compare against stored data</li></ul><h2 class="anchor anchorWithStickyNavbar_y2LR" id="requirements">Requirements<a class="hash-link" href="#requirements" title="Direct link to heading">â€‹</a></h2><p>For this tutorial it&#x27;s helpful to know your way around the deepstream <a href="/docs/docs/server/configuration">configuration</a> as we&#x27;ll need to tell the server where we stored our permissioning rules. deepstream supports a variety of communication concepts such as data-sync, publish-subscribe or request-response and <em>Valve</em> is flexible enough to allow different rules for each concept. This guide will mostly focus on <a href="/docs/tutorials/core/datasync/records">records</a>, so it&#x27;d be good to familiarize yourself with them. Since permissioning is fundamentally about the rights of individual clients, it would also be good to know how <a href="/docs/tutorials/concepts/security">user authentication</a> works in deepstream.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="lets-start-with-an-example">Let&#x27;s start with an example<a class="hash-link" href="#lets-start-with-an-example" title="Direct link to heading">â€‹</a></h3><p>Imagine you are running a discussion forum. To avoid vandalism and spam, users have to wait 24 hours before they can create new posts or modify existing posts after registration. This means we&#x27;ll need to store the time the user registered along with their account information. This can be done dynamically using <a href="/docs/tutorials/core/auth/http-webhook">http authentication</a>, but to keep things simple for this tutorial we&#x27;ll just store it as <code>timestamp</code> within the <code>serverData</code> using deepstream&#x27;s file-based authentication. A user entry in <code>conf/users.yml</code> might look as follows:</p><div class="codeBlockContainer_J+bg language-yaml theme-code-block"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">JohnDoe</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">password</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gvb4563Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">serverData</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">timestamp</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1482256123052</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The snippet above shows a user <code>JohnDoe</code>. The server hosting the forum needs to
know when John Doe registered so there is a <code>timestamp</code> in the <code>serverData</code>
section.</p><p>With deepstream as a back-end, it makes sense to store all forum threads in records (this is the <a href="/docs/tutorials/core/datasync/records">data-sync concept</a>). The following Valve snippet gives new users read-only access:</p><div class="codeBlockContainer_J+bg language-yaml theme-code-block"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">record</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">&quot;*&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">read</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">listen</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">delete</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">create</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;user.data.timestamp + 24 * 3600 * 1000 &lt; now&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">write</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;user.data.timestamp + 24 * 3600 * 1000 &lt; now&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The <code>record</code> label signifies that the following rules apply to operations involving records; the pattern in the line below is a wild card matching every record name. In deepstream, records can be created, written to, deleted, read from, and you can listen to clients subscribing to a record. With Valve, you can have different permissions for each of these actions. In the Valve snippet above, we permit everyone to read records, listen to subscription, and we disallow record deletion. Finally, in the last two lines we grant users <code>create</code> and <code>write</code> permissions only if the accounts are older than 24 hours by comparing the <code>timestamp</code> from the user&#x27;s <code>serverData</code> with the current time; <code>now</code> returns <a href="https://en.wikipedia.org/wiki/Unix_time" target="_blank" rel="noopener noreferrer">Unix time</a> like <code>Date.now()</code> in JavaScript, in milliseconds and 24 <!-- -->*<!-- --> 3600 <!-- -->*<!-- --> 1000 milliseconds are 24 hours.</p><p>Lastly, we need to update the config file to make use of our custom permissions. Assuming we stored the permissions in the path <code>conf/permissions.yml</code>, we can instruct the deepstream server to load our settings with the following lines in <code>conf/config.yml</code>:</p><div class="codeBlockContainer_J+bg language-yaml theme-code-block"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">permission</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">options</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./permissions.yml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>As you saw above, setting up deepstream&#x27;s file-based permissioning facilities requires a file with permissioning rules, changes to the configuration file, and optionally some user-specific data.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="permissioning">Permissioning<a class="hash-link" href="#permissioning" title="Direct link to heading">â€‹</a></h2><p>A generic Valve rule might look as follows:</p><div class="codeBlockContainer_J+bg language-yaml theme-code-block"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">concept</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">&quot;pattern&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">action</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;expression&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>For every action, there is usually a corresponding function in the client API, e.g., the record <code>write</code> permissions are needed when calling <code>record.set()</code> in
the JavaScript client API. Every record, RPC, event, and authenticated user in deepstream possesses a unique identifier (a name) and if Valve wants to find out
if a certain operation is permitted, then</p><ul><li>it looks for the appropriate section in the permissioning file for records, RPCs, or events, and so on,</li><li>it searches for the rule with the best match between pattern and identifier, and</li><li>it evaluates the right-hand side expression.</li></ul><p>In the following paragraphs, we present the possible actions.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="file-format">File Format<a class="hash-link" href="#file-format" title="Direct link to heading">â€‹</a></h3><p>The Valve language uses <a href="https://en.wikipedia.org/wiki/YAML" target="_blank" rel="noopener noreferrer">YAML</a> or <a href="https://en.wikipedia.org/wiki/JSON" target="_blank" rel="noopener noreferrer">JSON</a> file format and the file with the
permissioning rules must always contain rules for every possible identifier because the server will not supply default values. Note that the deepstream server ships with a permissions file in <code>conf/permissions.yml</code> which permits every action. Valve is designed to first and foremost use identifiers to match permissionable objects with corresponding rules. Thus, identifiers should be chosen such that rules can be selected only based on the identifier.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="identifier-matching">Identifier Matching<a class="hash-link" href="#identifier-matching" title="Direct link to heading">â€‹</a></h3><p>Valve can match identifiers using fixed (sub-)strings, wild cards, and placeholders (with deepstream, we call them <em>path variables</em>); these placeholders can be used in the expressions. Suppose we store a user&#x27;s first name, middle name, and last name in the format <code>name/lastname/middlename/firstname</code> and have a look at the following Valve code:</p><div class="codeBlockContainer_J+bg language-yaml theme-code-block"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">presence</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">&#x27;name/Doe/$middlename/$firstname&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">allow</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>User names that match this rule are, e.g., John Adam Doe (in this case, the record identifier is <code>name/Doe/Adam/John</code>) or Jane Eve Doe (<code>name/Doe/Eve/Jane</code>); in the former case, <code>$firstname === &#x27;John&#x27;</code> and in the latter case <code>$firstname === &#x27;Jane&#x27;</code>.</p><p>The wild card symbol in Valve is the asterisk (the symbol <code>*</code>) and <code>*</code> matches every character until the end of the string. Placeholders start with a dollar
sign followed by alphanumeric characters and match everything until a slash is encountered. In principle, identifiers can contain any character. Nevertheless,
if you use an asterisk in an identifier, deepstream offers no way to match specifically this character.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="expressions">Expressions<a class="hash-link" href="#expressions" title="Direct link to heading">â€‹</a></h3><p>After identifier matching, deepstream will evaluate the right-hand side expression. The expression can use a subset of JavaScript including</p><ul><li>arithmetic expressions,</li><li>the <a href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Operators/Conditional_Operator" target="_blank" rel="noopener noreferrer">conditional operator</a>,</li><li>comparison operators,</li><li>the string functions <code>startsWith</code>, <code>endsWith</code>, <code>indexOf</code>, <code>match</code>,
<code>toUpperCase</code>, <code>toLowerCase</code>, and <code>trim</code>.</li></ul><p>Additionally, you can use the current time (on the server) with <code>now</code>, you can access deepstream data, and cross-reference records.</p><p>Any deepstream client needs to log onto the server and the user data can be accessed with Valve but note that user&#x27;s are not necessarily authenticated unless this is forbidden in the config. You can check for authenticated users with <code>user.isAuthenticated</code> (the ternary operator <code>?:</code> may prove useful when checking
this property). If a client authenticated, its user name can be accessed with <code>user.name</code> and its server data with <code>user.data</code>.  Additionally, Valve allows
you to examine data associated with a rule, e.g., for a record, this means one can examine old and new value.  Since the data is dependent on the type (record,
event, or RPC, and so on), we will discuss this detail in the sections on the specific types.</p><p>Valve gives you the ability to cross reference data in your records. In your right-hand side expression, use the term <code>_(identifier)</code> to access the record
with the given identifier, where <code>identifier</code> is interpreted as a JavaScript expression returning a string, e.g., <code>_(&#x27;family/&#x27; + $lastname)</code>. The cross
referenced record must exist. Note that cross references ignore Valve permissions meaning you gain indirect read access irrespective of the Valve rules.</p><p>When evaluating expressions, you need to keep several pitfalls in mind. Using the current time with <code>now</code> requires you to consider the usual <a href="http://infiniteundo.com/post/25326999628/falsehoods-programmers-believe-about-time" target="_blank" rel="noopener noreferrer">limitations of
time-dependent operations</a> on computers and additionally, <code>now</code> is evaluated on the server; you should keep this in mind whenever a client uses the <em>current</em> time in its code. Valve allows you to cross reference stored data but this is computationally expensive. Thus, the default config shipped with deepstream allows no more than three cross references as of December 21, 2016. Finally, the usual warnings about type coercion (implicit type conversions), <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Comparison_Operators" target="_blank" rel="noopener noreferrer">JavaScript comparison operators</a>, and <a href="http://www.w3schools.com/js/js_numbers.asp" target="_blank" rel="noopener noreferrer">floating-point arithmetic</a> apply.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="records">Records<a class="hash-link" href="#records" title="Direct link to heading">â€‹</a></h3><p>Records can be created, deleted, read from, written to, and you can <em>listen</em> to other clients subscribing to records (the <a href="/docs/tutorials/core/datasync/records">record tutorial</a> elaborates on these operations and it explains the differences between unsubscribing from, discarding, and deleting records). The following snippet is the default Valve code for records:</p><div class="codeBlockContainer_J+bg language-yaml theme-code-block"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">record</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">&quot;*&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">create</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># client.record.getRecord()</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">read</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># client.record.getRecord(), record.get()</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">write</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># record.set()</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">listen</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># record.listen()</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">delete</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># record.delete()</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In Valve, you can access the current record contents by referencing <code>oldData</code> and for the <code>write</code> operation, the modified record can be examined with <code>data</code>.</p><p>Note that <code>create</code> permissions are only invoked by <code>getRecord()</code> if the requested record does not exist, otherwise only reading rights are required.
Similarly, writes are always successful if the record does not have to be modified, e.g., modified and unmodified record are identical. Moreover, if a write operation is rejected by the server, then the client must handle the resulting error message; otherwise the client copy of the record will be out of sync with the server state. Finally, do not mix up the <code>path</code> given to <code>record.get()</code> and <code>record.set()</code> with the record <em>identifier</em> that is used by Valve.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="user-presence">User Presence<a class="hash-link" href="#user-presence" title="Direct link to heading">â€‹</a></h3><p>deepstream can notify you when authenticated users log in. The permissioning key is called <code>presence</code> and the only option is to allow or disallow listening:</p><div class="codeBlockContainer_J+bg language-yaml theme-code-block"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">presence</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">&quot;*&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">allow</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># client.subscribe()</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="events">Events<a class="hash-link" href="#events" title="Direct link to heading">â€‹</a></h3><p><a href="/docs/tutorials/core/pubsub/events">Events</a> can be published and subscribed to. Moreover, a client emitting events may listen to event subscriptions. The actions can be permissioned in the section <code>events</code>:</p><div class="codeBlockContainer_J+bg language-yaml theme-code-block"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">events</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">&quot;*&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">publish</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># client.event.emit()</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">subscribe</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># client.event.subscribe()</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">listen</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># client.event.listen()</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The <code>publish</code> action allows the examination of the data by referencing <code>data</code> in the expression.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="rpcs">RPCs<a class="hash-link" href="#rpcs" title="Direct link to heading">â€‹</a></h3><p><a href="/docs/tutorials/core/request-response/rpc">Remote procedure calls</a> can be provided or requested. The corresponding permissioning section is identified by the key <code>rpc</code>:</p><div class="codeBlockContainer_J+bg language-yaml theme-code-block"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">rpc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">&quot;*&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">provide</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># client.rpc.provide()</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">request</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># client.rpc.make()</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="configuring-for-file-based-permissioning">Configuring for File-Based Permissioning<a class="hash-link" href="#configuring-for-file-based-permissioning" title="Direct link to heading">â€‹</a></h3><p>To use file-based permissioning, the config file must contain the key <code>permission.type</code> with the value <code>config</code>. The name of the permissioning file must be provided in the deepstream config file under the key <code>permission.options.path</code> and can be chosen arbitrarily. If a relative path is used to indicate its location, then this path uses the directory containing the config file as base directory.</p><p>In summary, if the permissioning rules can be found in <code>conf/permissions.yml</code> and if the configuration file is <code>conf/config.yml</code>, then a minimal config for
file-based permissioning looks as follows:</p><div class="codeBlockContainer_J+bg language-yaml theme-code-block"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">permission</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">options</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./permissions.yml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="further-reading">Further Reading<a class="hash-link" href="#further-reading" title="Direct link to heading">â€‹</a></h2><p>More compact introductions (or refreshers) are the tutorials <a href="/docs/tutorials/core/permission/valve-simple"><em>Valve Permissioning Simple</em></a>, <a href="/docs/tutorials/core/permission/valve-advanced"><em>Valve Permissioning Advanced</em></a>, and <a href="/docs/tutorials/core/permission/valve-dynamic"><em>Dynamic Permissions using Valve</em></a>. To learn how to sent user-specific data using Valve, have a look at the <a href="/docs/tutorials/core/permission/user-specific-data">user-specific data guide</a>.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/deepstreamIO/deepstreamIO.github.io/docs/00-tutorials/20-core/30-permission/10-valve-introduction.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_mt2f"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/tutorials/core/auth/jwt-auth"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Authentication using JWT</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/tutorials/core/permission/valve-simple"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Valve Simple</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#requirements" class="table-of-contents__link toc-highlight">Requirements</a><ul><li><a href="#lets-start-with-an-example" class="table-of-contents__link toc-highlight">Let&#39;s start with an example</a></li></ul></li><li><a href="#permissioning" class="table-of-contents__link toc-highlight">Permissioning</a><ul><li><a href="#file-format" class="table-of-contents__link toc-highlight">File Format</a></li><li><a href="#identifier-matching" class="table-of-contents__link toc-highlight">Identifier Matching</a></li><li><a href="#expressions" class="table-of-contents__link toc-highlight">Expressions</a></li><li><a href="#records" class="table-of-contents__link toc-highlight">Records</a></li><li><a href="#user-presence" class="table-of-contents__link toc-highlight">User Presence</a></li><li><a href="#events" class="table-of-contents__link toc-highlight">Events</a></li><li><a href="#rpcs" class="table-of-contents__link toc-highlight">RPCs</a></li><li><a href="#configuring-for-file-based-permissioning" class="table-of-contents__link toc-highlight">Configuring for File-Based Permissioning</a></li></ul></li><li><a href="#further-reading" class="table-of-contents__link toc-highlight">Further Reading</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Content</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/tutorials/install/linux">Install</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/tutorials/concepts/what-is-deepstream">Tutorials</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/docs">Documentation</a></li><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/deepstreamIO/deepstreamIO.github.io/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Discussions<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/deepstreamIO/deepstream.io/blob/master/CHANGELOG.md" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Server changelog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/deepstreamIO/deepstream.io-client-js/blob/master/CHANGELOG.md" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Client changelog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2023 deepstreamHub GmbH and contributors</div></div></div></footer></div>
<script src="/assets/js/runtime~main.4b67704a.js"></script>
<script src="/assets/js/main.a9eddb7b.js"></script>
</body>
</html>