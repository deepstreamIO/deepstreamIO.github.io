"use strict";(self.webpackChunkdeepstreamio_github_io=self.webpackChunkdeepstreamio_github_io||[]).push([[3117],{3059:(e,n,t)=>{t.d(n,{A:()=>a});const a="data:image/jpeg;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6NzI3MmRjMDIwNjM1Zjg1NTNiNzVkZGYzYTY0YjRlYzYxNThiNjQ0NjNjODA1Nzk5NDRiNTVmNWQ1NTBlYzhmYQpzaXplIDEyNTEwMzYK"},5680:(e,n,t)=>{t.d(n,{xA:()=>d,yg:()=>h});var a=t(6540);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function o(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var s=a.createContext({}),p=function(e){var n=a.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):l(l({},n),e)),t},d=function(e){var n=p(e.components);return a.createElement(s.Provider,{value:n},e.children)},u="mdxType",c={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},g=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,d=o(e,["components","mdxType","originalType","parentName"]),u=p(t),g=r,h=u["".concat(s,".").concat(g)]||u[g]||c[g]||i;return t?a.createElement(h,l(l({ref:n},d),{},{components:t})):a.createElement(h,l({ref:n},d))}));function h(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var i=t.length,l=new Array(i);l[0]=g;var o={};for(var s in n)hasOwnProperty.call(n,s)&&(o[s]=n[s]);o.originalType=e,o[u]="string"==typeof e?e:r,l[1]=o;for(var p=2;p<i;p++)l[p]=t[p];return a.createElement.apply(null,l)}return a.createElement.apply(null,t)}g.displayName="MDXCreateElement"},7110:(e,n,t)=>{t.r(n),t.d(n,{contentTitle:()=>l,default:()=>u,frontMatter:()=>i,metadata:()=>o,toc:()=>s});var a=t(8168),r=(t(6540),t(5680));const i={title:"IoT Light Sensor",description:"deepstream HTTP Internet of Things Light Sensor tutorial",tags:["HTTP","IoT","Arduino","ESP8266","WiFi"]},l=void 0,o={unversionedId:"guides/example-apps/http-iot",id:"guides/example-apps/http-iot",title:"IoT Light Sensor",description:"deepstream HTTP Internet of Things Light Sensor tutorial",source:"@site/docs/20-guides/example-apps/http-iot.md",sourceDirName:"20-guides/example-apps",slug:"/guides/example-apps/http-iot",permalink:"/docs/guides/example-apps/http-iot",editUrl:"https://github.com/deepstreamIO/deepstreamIO.github.io/docs/20-guides/example-apps/http-iot.md",tags:[{label:"HTTP",permalink:"/docs/tags/http"},{label:"IoT",permalink:"/docs/tags/io-t"},{label:"Arduino",permalink:"/docs/tags/arduino"},{label:"ESP8266",permalink:"/docs/tags/esp-8266"},{label:"WiFi",permalink:"/docs/tags/wi-fi"}],version:"current",frontMatter:{title:"IoT Light Sensor",description:"deepstream HTTP Internet of Things Light Sensor tutorial",tags:["HTTP","IoT","Arduino","ESP8266","WiFi"]},sidebar:"tutorialSidebar",previous:{title:"IoT Fridge Monitor",permalink:"/docs/guides/example-apps/http-iot-fridge-monitor"},next:{title:"Music Collection (CRUD)",permalink:"/docs/guides/example-apps/music-collection"}},s=[{value:"Hardware",id:"hardware",children:[],level:2},{value:"Setting up",id:"setting-up",children:[],level:2},{value:"Reading the sensor",id:"reading-the-sensor",children:[],level:2},{value:"Connecting to WiFi",id:"connecting-to-wifi",children:[],level:2},{value:"Building a request",id:"building-a-request",children:[],level:2},{value:"Handling failure",id:"handling-failure",children:[],level:2},{value:"Subscribing to updates",id:"subscribing-to-updates",children:[],level:2}],p={toc:s},d="wrapper";function u(e){let{components:n,...i}=e;return(0,r.yg)(d,(0,a.A)({},p,i,{components:n,mdxType:"MDXLayout"}),(0,r.yg)("p",null,"deepstream's HTTP API is perfect for low-frequency data updates in low-power\nenvironments where the cost of establishing and maintaining a WebSocket\nconnection can be prohibitive."),(0,r.yg)("p",null,"In this tutorial we'll use a remote, low-power ESP8266-based system-on-chip and\na light sensor to send live light readings to deepstream and display them on\na webpage. Additionally, red and green LEDs will show whether the update has\nbeen successful."),(0,r.yg)("p",null,"I'd recommend being familiar with the basics of\n",(0,r.yg)("a",{parentName:"p",href:"../../tutorials/core/datasync/records/"},"Records")," before you start."),(0,r.yg)("p",null,"Here's how it looks:"),(0,r.yg)("p",null,(0,r.yg)("img",{alt:"circuit",src:t(3059).A})),(0,r.yg)("h2",{id:"hardware"},"Hardware"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},'Get hold of a board with an ESP8266 chip. There are many such boards\navailable through merchants and action sites for as little as $5. The one\nwe\'re using is listed as an "Elegiant Nodemcu Lua ESP8266 ESP 12E" and cost\n\u20ac10 delivered.'),(0,r.yg)("li",{parentName:"ul"},"An electronics breadboard and jumper cables."),(0,r.yg)("li",{parentName:"ul"},"A photoresistor/LDR like ",(0,r.yg)("a",{parentName:"li",href:"http://uk.farnell.com/excelitas-tech/vt90n1/ldr-200kohm-80mw-vt900-series/dp/2293503"},"this one"),"."),(0,r.yg)("li",{parentName:"ul"},"1 x 20k\u03a9 resistor (a pull-up for the photoresistor)."),(0,r.yg)("li",{parentName:"ul"},"2 x status LEDs \u2013 1 red, 1 green."),(0,r.yg)("li",{parentName:"ul"},"2 x 330\u03a9 resistors for the LEDs.")),(0,r.yg)("p",null,(0,r.yg)("img",{alt:"Schematic",src:t(7561).A})),(0,r.yg)("p",null,"The circuit is very simple to put together, just make sure the LEDs are correctly oriented."),(0,r.yg)("h2",{id:"setting-up"},"Setting up"),(0,r.yg)("p",null,"We'll be using the Arduino IDE to program the device."),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"The Arduino IDE is available from ",(0,r.yg)("a",{parentName:"li",href:"https://www.arduino.cc/en/Main/Software#download"},"here"),"."),(0,r.yg)("li",{parentName:"ul"},"To get your board setup with Arduino IDE I recommend following a guide like\n",(0,r.yg)("a",{parentName:"li",href:"http://www.instructables.com/id/Quick-Start-to-Nodemcu-ESP8266-on-Arduino-IDE/"},"this one"),"\nand try to load up an example sketch like Blink."),(0,r.yg)("li",{parentName:"ul"},"For OSX Yosemite I needed to install the CH340G driver available from\n",(0,r.yg)("a",{parentName:"li",href:"http://kig.re/2014/12/31/how-to-use-arduino-nano-mini-pro-with-CH340G-on-mac-osx-yosemite.html"},"here"),"."),(0,r.yg)("li",{parentName:"ul"},"With the board now setup, go to ",(0,r.yg)("inlineCode",{parentName:"li"},"Sketch > Include Library > Manage Libraries..."),"\nand search for the ArduinoJson, then click on Install.")),(0,r.yg)("p",null,"Go to ",(0,r.yg)("inlineCode",{parentName:"p"},"File -> New")," to create a new sketch.\nThe empty sketch defines two functions:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("inlineCode",{parentName:"li"},"setup()")," contains initialization code that is run once when the board is powered on."),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("inlineCode",{parentName:"li"},"loop()")," is run repeatedly until the device is switched off.")),(0,r.yg)("p",null,"To make debugging easier, we can enable debugging over a serial connection."),(0,r.yg)("p",null,"To do so, simply add the following to the ",(0,r.yg)("inlineCode",{parentName:"p"},"setup()")," function:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-cpp"},"Serial.begin(115200);\n")),(0,r.yg)("p",null,"and open ",(0,r.yg)("inlineCode",{parentName:"p"},"Tools > Serial Monitor")," to see any output generated."),(0,r.yg)("h2",{id:"reading-the-sensor"},"Reading the sensor"),(0,r.yg)("p",null,"To start with, we'll want to read the sensor."),(0,r.yg)("p",null,"The analog input pin is the one labelled ",(0,r.yg)("inlineCode",{parentName:"p"},"A0"),", and a global variable of the\nsame name is defined."),(0,r.yg)("p",null,"We need to initialize this as an input before we read from it:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-cpp"},"const int sensorPin = A0;\n\nvoid setup() {\n    Serial.begin(115200);\n\n    // initialize sensor\n    pinMode(sensorPin, INPUT);\n}\n")),(0,r.yg)("p",null,"Now in ",(0,r.yg)("inlineCode",{parentName:"p"},"loop()")," we can use the function ",(0,r.yg)("inlineCode",{parentName:"p"},"analogRead(int pin)")," to read the value\non the sensor and ",(0,r.yg)("inlineCode",{parentName:"p"},"Serial.printf()")," to print the value."),(0,r.yg)("p",null,"The variable ",(0,r.yg)("inlineCode",{parentName:"p"},"readDelayMs")," defines the amount of time between readings in milliseconds."),(0,r.yg)("p",null,"The value will be an integer between 0 and 1024 corresponding to the brightness level."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-cpp"},'const int readDelayMs = 10000;\n\nvoid loop() {\n    int level = analogRead(sensorPin);\n    Serial.printf("Light level: %d\\n", level);\n\n    delay(readDelayMs);\n}\n')),(0,r.yg)("p",null,"If you build and upload the script now and look in the ",(0,r.yg)("inlineCode",{parentName:"p"},"Serial Monitor")," window\nyou should see log lines, with the value changing as the light level changes e.g."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre"},"Light level: 270\nLight level: 373\nLight level: 384\n")),(0,r.yg)("h2",{id:"connecting-to-wifi"},"Connecting to WiFi"),(0,r.yg)("p",null,"To submit this data to deepstream we'll need an internet connection, and for\nthat we'll use the chip's builtin WiFi and networking functionality."),(0,r.yg)("p",null,"Include the following headers:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-cpp"},"#include <ESP8266WiFiMulti.h>\n#include <ESP8266HTTPClient.h>\n")),(0,r.yg)("p",null,"Now we need to initialize the WiFi client, and wait for the connection to be\nsetup:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-cpp"},'ESP8266WiFiMulti WiFiMulti;\n\nconst char* ssid = "YOUR_NETWORK_SSID";\nconst char* password = "YOUR_NETWORK_PASSWORD";\n\nvoid setup() {\n    // ...\n\n    // connect to WiFi\n    WiFiMulti.addAP(ssid, password);\n}\n\nvoid loop() {\n    if (WiFiMulti.run() != WL_CONNECTED) {\n      delay(200);\n      return;\n    }\n\n    // ...\n}\n')),(0,r.yg)("h2",{id:"building-a-request"},"Building a request"),(0,r.yg)("p",null,"We're going to be writing the light level into a\n",(0,r.yg)("a",{parentName:"p",href:"../../tutorials/core/datasync/records/"},"record")," each time it's read, so let's create a\nfunction called ",(0,r.yg)("inlineCode",{parentName:"p"},"updateRecord")," that takes the level as an argument, and call it\nin ",(0,r.yg)("inlineCode",{parentName:"p"},"loop()"),"."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-cpp"},"void loop() {\n    // print level...\n    updateRecord(level);\n    // delay\n}\n\nvoid updateRecord(int level) {\n    // ...\n}\n")),(0,r.yg)("p",null,"You'll also need to select the relevant TLS fingerprint that relates to the\nsubdomain in your HTTP URL, or you can follow\n",(0,r.yg)("a",{parentName:"p",href:"https://github.com/esp8266/Arduino/issues/2556#issuecomment-271372001"},"the instructions here"),"\nto generate your own:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-cpp"},'const char* deepstreamHttpUrl = "<YOUR HTTP URL>";\n/*\n * Generated TLS fingerprints:\n *\n * 013.deepstream.com: "3A:FC:6E:78:94:18:C0:A2:36:F3:C7:DF:86:27:4B:5A:CA:CF:28:3F"\n * 035.deepstream.com: "57:18:5A:22:07:94:03:EF:90:C9:C2:56:58:C9:BB:06:66:A6:EA:76"\n * 154.deepstream.com: "3C:65:CA:7C:3F:43:2D:FF:A1:63:38:F3:23:D5:59:25:E4:85:8C:0F"\n */\nconst char* deepstreamTlsFingerprint = "<YOUR HTTP DOMAIN FINGERPRINT>";\n')),(0,r.yg)("p",null,"We have to create a new ",(0,r.yg)("inlineCode",{parentName:"p"},"HTTPClient")," for each message, so we'll create that in\n",(0,r.yg)("inlineCode",{parentName:"p"},"updateRecord()")," and make sure it's closed after."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-cpp"},"HTTPClient http;\n\n// configure client\nhttp.begin(deepstreamHttpUrl, deepstreamTlsFingerprint);\n\n// ...\n\nhttp.end();\n")),(0,r.yg)("p",null,"The deepstream HTTP API uses a JSON payload, so to help us build that we'll\ninclude the ",(0,r.yg)("inlineCode",{parentName:"p"},"ArduinoJSON")," library we installed earlier."),(0,r.yg)("p",null,"The body we're creating needs to look like this:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-json"},'{\n  "topic": "record",\n  "action": "write",\n  "recordName": "readings/light-level",\n  "path": "value",\n  "data": 534 /* value read from the sensor */\n}\n')),(0,r.yg)("p",null,"Here's the code to do that:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-cpp"},'#include <ArduinoJson.h>\n\nvoid updateRecord(int level) {\n    // ...\n\n    // create message body\n    StaticJsonBuffer<200> bodyBuff;\n    JsonObject& root = bodyBuff.createObject();\n    JsonArray& body = root.createNestedArray("body");\n    JsonObject& message = body.createNestedObject();\n    message["topic"] = "record";\n    message["action"] = "write";\n    message["recordName"] = "readings/light-level";\n    message["path"] = "value";\n    message["data"] = level;\n\n    // copy object into array\n    size_t bodySize = bodyBuff.size();\n    char requestBody[bodySize];\n    root.printTo(requestBody, bodySize);\n}\n')),(0,r.yg)("p",null,"Now let's put this in a POST request:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-cpp"},'void updateRecord(int level) {\n    // ...\n\n    // set content type\n    http.addHeader("Content-Type", "application/json");\n\n    // make request\n    int httpCode = http.POST(requestBody);\n}\n')),(0,r.yg)("h2",{id:"handling-failure"},"Handling failure"),(0,r.yg)("p",null,"There are three main ways the record update could fail:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},"The request could fail e.g. a connection error\nIn this case ",(0,r.yg)("inlineCode",{parentName:"p"},"httpCode")," will be negative.")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},"The request could fail to parse or authenticate on the server.\nIn this case ",(0,r.yg)("inlineCode",{parentName:"p"},"httpCode")," will be a 4xx response.")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},"The record update could fail e.g. the Valve permissions to not allow writes\nIn this case ",(0,r.yg)("inlineCode",{parentName:"p"},"httpCode")," will be 200, but the JSON response will indicate a failure."))),(0,r.yg)("p",null,"Let's handle those and log the outcome:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-cpp"},'void updateRecord(int level) {\n    // ...\n\n    if(httpCode == HTTP_CODE_OK) {\n        // parse response\n        String payload = http.getString();\n        StaticJsonBuffer<200> respBuff;\n        JsonObject& resp = respBuff.parseObject(payload);\n        if (!resp["body"][0]["success"]) {\n            // failed to update record\n            Serial.printf("Record update error: %s\\n", resp["body"][0]["error"]);\n            return;\n        }\n        // record update success\n        Serial.println("Record was updated successfully!");\n    } else if (httpCode < 0) {\n        Serial.printf("Request failed, error: %s\\n", http.errorToString(httpCode).c_str());\n    } else {\n        Serial.printf("Error response %d: %s\\n", httpCode, http.getString().c_str());\n    }\n}\n')),(0,r.yg)("p",null,"Now let's set up the green LED to flash if the update is successful, the red LED otherwise:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-cpp"},'const int greenLed = D1;\nconst int redLed = D2;\n\nvoid setup() {\n    // ...\n\n    // initialize LEDs\n    pinMode(redLed, OUTPUT);\n    pinMode(greenLed, OUTPUT);\n    digitalWrite(redLed, LOW);\n    digitalWrite(greenLed, LOW);\n}\n\nvoid flashLed(int led) {\n    digitalWrite(led, HIGH);\n    delay(500);\n    digitalWrite(led, LOW);\n}\n\nvoid updateRecord(int level) {\n    // httpCode will be negative on error\n    if(httpCode == HTTP_CODE_OK) {\n        // parse payload\n        // ...\n        if (!resp["body"][0]["success"]) {\n            // failed to update record\n            Serial.printf("Record update error: %s\\n", resp["body"][0]["error"]);\n            flashLed(redLed);\n            return;\n        }\n        // record update success\n        Serial.println("Record was updated successfully!");\n        flashLed(greenLed);\n    } else if (httpCode < 0) {\n        Serial.printf("Request failed, error: %s\\n", http.errorToString(httpCode).c_str());\n        flashLed(redLed);\n    } else {\n        Serial.printf("Error response %d: %s\\n", httpCode, http.getString().c_str());\n        flashLed(redLed);\n    }\n}\n')),(0,r.yg)("h2",{id:"subscribing-to-updates"},"Subscribing to updates"),(0,r.yg)("p",null,"Now let's display those updates as they happen using Javascript and log them to the console:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-html"},"<head>\n    <script src=\"http://code.deepstream.io/js/latest/deepstream.min.js\"><\/script>\n    <script type=\"text/javascript\">\n      const ds = new DeepstreamClient('localhost:6020')\n      ds.login()\n\n      const record = ds.record.getRecord('readings/light-level')\n      record.subscribe('value', (value) => {\n        console.log('Light level update:', value)\n      })\n    <\/script>\n</head>\n")),(0,r.yg)("p",null,"This simple setup has all the elements required to aggregate and display\nreadings from millions of incoming sensors."),(0,r.yg)("p",null,"For the full code, please take a look at the GitHub ",(0,r.yg)("a",{href:"https://github.com/deepstreamIO/dsh-tutorial-http-iot"},"repository"),"."))}u.isMDXComponent=!0},7561:(e,n,t)=>{t.d(n,{A:()=>a});const a="data:image/png;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6NjFhZDFjMTljY2ZkNTBmNWRmYTA1ZGFjN2U4OTMwMDkxNDM3MTcxMmNkYzNkMzZmMGJjNWUyZDE2NDAxOTAwZgpzaXplIDM3MDI4Cg=="}}]);