"use strict";(self.webpackChunkdeepstreamio_github_io=self.webpackChunkdeepstreamio_github_io||[]).push([[6362],{5431:(e,n,i)=>{i.r(n),i.d(n,{contentTitle:()=>s,default:()=>c,frontMatter:()=>a,metadata:()=>o,toc:()=>l});var t=i(8168),r=(i(6540),i(5680));const a={title:"Valve Introduction",description:"Learn permissions with Valve"},s=void 0,o={unversionedId:"tutorials/core/permission/valve-introduction",id:"tutorials/core/permission/valve-introduction",title:"Valve Introduction",description:"Learn permissions with Valve",source:"@site/docs/00-tutorials/20-core/30-permission/10-valve-introduction.md",sourceDirName:"00-tutorials/20-core/30-permission",slug:"/tutorials/core/permission/valve-introduction",permalink:"/docs/tutorials/core/permission/valve-introduction",editUrl:"https://github.com/deepstreamIO/deepstreamIO.github.io/docs/00-tutorials/20-core/30-permission/10-valve-introduction.md",tags:[],version:"current",sidebarPosition:10,frontMatter:{title:"Valve Introduction",description:"Learn permissions with Valve"},sidebar:"tutorialSidebar",previous:{title:"Authentication using JWT",permalink:"/docs/tutorials/core/auth/jwt-auth"},next:{title:"Valve Simple",permalink:"/docs/tutorials/core/permission/valve-simple"}},l=[{value:"Requirements",id:"requirements",children:[{value:"Let&#39;s start with an example",id:"lets-start-with-an-example",children:[],level:3}],level:2},{value:"Permissioning",id:"permissioning",children:[{value:"File Format",id:"file-format",children:[],level:3},{value:"Identifier Matching",id:"identifier-matching",children:[],level:3},{value:"Expressions",id:"expressions",children:[],level:3},{value:"Records",id:"records",children:[],level:3},{value:"User Presence",id:"user-presence",children:[],level:3},{value:"Events",id:"events",children:[],level:3},{value:"RPCs",id:"rpcs",children:[],level:3},{value:"Configuring for File-Based Permissioning",id:"configuring-for-file-based-permissioning",children:[],level:3}],level:2},{value:"Further Reading",id:"further-reading",children:[],level:2}],p={toc:l},d="wrapper";function c(e){let{components:n,...i}=e;return(0,r.yg)(d,(0,t.A)({},p,i,{components:n,mdxType:"MDXLayout"}),(0,r.yg)("p",null,"deepstream uses a powerful permission-language called Valve that allows you to specify which user can perform which action with which data."),(0,r.yg)("p",null,"With Valve you can"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"Restrict access for individual users or groups"),(0,r.yg)("li",{parentName:"ul"},"Permission individual actions (e.g. write, publish or listen)"),(0,r.yg)("li",{parentName:"ul"},"Permission individual records, events or rpcs"),(0,r.yg)("li",{parentName:"ul"},"validate incoming data"),(0,r.yg)("li",{parentName:"ul"},"compare against stored data")),(0,r.yg)("h2",{id:"requirements"},"Requirements"),(0,r.yg)("p",null,"For this tutorial it's helpful to know your way around the deepstream ",(0,r.yg)("a",{parentName:"p",href:"../../../docs/server/configuration"},"configuration")," as we'll need to tell the server where we stored our permissioning rules. deepstream supports a variety of communication concepts such as data-sync, publish-subscribe or request-response and ",(0,r.yg)("em",{parentName:"p"},"Valve")," is flexible enough to allow different rules for each concept. This guide will mostly focus on ",(0,r.yg)("a",{parentName:"p",href:"../../core/datasync/records"},"records"),", so it'd be good to familiarize yourself with them. Since permissioning is fundamentally about the rights of individual clients, it would also be good to know how ",(0,r.yg)("a",{parentName:"p",href:"../../concepts/security"},"user authentication")," works in deepstream."),(0,r.yg)("h3",{id:"lets-start-with-an-example"},"Let's start with an example"),(0,r.yg)("p",null,"Imagine you are running a discussion forum. To avoid vandalism and spam, users have to wait 24 hours before they can create new posts or modify existing posts after registration. This means we'll need to store the time the user registered along with their account information. This can be done dynamically using ",(0,r.yg)("a",{parentName:"p",href:"../../core/auth/http-webhook"},"http authentication"),", but to keep things simple for this tutorial we'll just store it as ",(0,r.yg)("inlineCode",{parentName:"p"},"timestamp")," within the ",(0,r.yg)("inlineCode",{parentName:"p"},"serverData")," using deepstream's file-based authentication. A user entry in ",(0,r.yg)("inlineCode",{parentName:"p"},"conf/users.yml")," might look as follows:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},"JohnDoe:\n    password: gvb4563Z\n    serverData:\n        timestamp: 1482256123052\n")),(0,r.yg)("p",null,"The snippet above shows a user ",(0,r.yg)("inlineCode",{parentName:"p"},"JohnDoe"),". The server hosting the forum needs to\nknow when John Doe registered so there is a ",(0,r.yg)("inlineCode",{parentName:"p"},"timestamp")," in the ",(0,r.yg)("inlineCode",{parentName:"p"},"serverData"),"\nsection."),(0,r.yg)("p",null,"With deepstream as a back-end, it makes sense to store all forum threads in records (this is the ",(0,r.yg)("a",{parentName:"p",href:"../datasync/records"},"data-sync concept"),"). The following Valve snippet gives new users read-only access:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},'record:\n    "*":\n        read: true\n        listen: true\n        delete: false\n        create: "user.data.timestamp + 24 * 3600 * 1000 < now"\n        write: "user.data.timestamp + 24 * 3600 * 1000 < now"\n')),(0,r.yg)("p",null,"The ",(0,r.yg)("inlineCode",{parentName:"p"},"record")," label signifies that the following rules apply to operations involving records; the pattern in the line below is a wild card matching every record name. In deepstream, records can be created, written to, deleted, read from, and you can listen to clients subscribing to a record. With Valve, you can have different permissions for each of these actions. In the Valve snippet above, we permit everyone to read records, listen to subscription, and we disallow record deletion. Finally, in the last two lines we grant users ",(0,r.yg)("inlineCode",{parentName:"p"},"create")," and ",(0,r.yg)("inlineCode",{parentName:"p"},"write")," permissions only if the accounts are older than 24 hours by comparing the ",(0,r.yg)("inlineCode",{parentName:"p"},"timestamp")," from the user's ",(0,r.yg)("inlineCode",{parentName:"p"},"serverData")," with the current time; ",(0,r.yg)("inlineCode",{parentName:"p"},"now")," returns ",(0,r.yg)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Unix_time"},"Unix time")," like ",(0,r.yg)("inlineCode",{parentName:"p"},"Date.now()")," in JavaScript, in milliseconds and 24 ","*"," 3600 ","*"," 1000 milliseconds are 24 hours."),(0,r.yg)("p",null,"Lastly, we need to update the config file to make use of our custom permissions. Assuming we stored the permissions in the path ",(0,r.yg)("inlineCode",{parentName:"p"},"conf/permissions.yml"),", we can instruct the deepstream server to load our settings with the following lines in ",(0,r.yg)("inlineCode",{parentName:"p"},"conf/config.yml"),":"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},"permission:\n    type: config\n    options:\n        path: ./permissions.yml\n")),(0,r.yg)("p",null,"As you saw above, setting up deepstream's file-based permissioning facilities requires a file with permissioning rules, changes to the configuration file, and optionally some user-specific data."),(0,r.yg)("h2",{id:"permissioning"},"Permissioning"),(0,r.yg)("p",null,"A generic Valve rule might look as follows:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},'concept:\n    "pattern":\n        action: "expression"\n')),(0,r.yg)("p",null,"For every action, there is usually a corresponding function in the client API, e.g., the record ",(0,r.yg)("inlineCode",{parentName:"p"},"write")," permissions are needed when calling ",(0,r.yg)("inlineCode",{parentName:"p"},"record.set()")," in\nthe JavaScript client API. Every record, RPC, event, and authenticated user in deepstream possesses a unique identifier (a name) and if Valve wants to find out\nif a certain operation is permitted, then"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"it looks for the appropriate section in the permissioning file for records, RPCs, or events, and so on,"),(0,r.yg)("li",{parentName:"ul"},"it searches for the rule with the best match between pattern and identifier, and"),(0,r.yg)("li",{parentName:"ul"},"it evaluates the right-hand side expression.")),(0,r.yg)("p",null,"In the following paragraphs, we present the possible actions."),(0,r.yg)("h3",{id:"file-format"},"File Format"),(0,r.yg)("p",null,"The Valve language uses ",(0,r.yg)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/YAML"},"YAML")," or ",(0,r.yg)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/JSON"},"JSON")," file format and the file with the\npermissioning rules must always contain rules for every possible identifier because the server will not supply default values. Note that the deepstream server ships with a permissions file in ",(0,r.yg)("inlineCode",{parentName:"p"},"conf/permissions.yml")," which permits every action. Valve is designed to first and foremost use identifiers to match permissionable objects with corresponding rules. Thus, identifiers should be chosen such that rules can be selected only based on the identifier."),(0,r.yg)("h3",{id:"identifier-matching"},"Identifier Matching"),(0,r.yg)("p",null,"Valve can match identifiers using fixed (sub-)strings, wild cards, and placeholders (with deepstream, we call them ",(0,r.yg)("em",{parentName:"p"},"path variables"),"); these placeholders can be used in the expressions. Suppose we store a user's first name, middle name, and last name in the format ",(0,r.yg)("inlineCode",{parentName:"p"},"name/lastname/middlename/firstname")," and have a look at the following Valve code:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},"presence:\n    'name/Doe/$middlename/$firstname':\n        allow: false\n")),(0,r.yg)("p",null,"User names that match this rule are, e.g., John Adam Doe (in this case, the record identifier is ",(0,r.yg)("inlineCode",{parentName:"p"},"name/Doe/Adam/John"),") or Jane Eve Doe (",(0,r.yg)("inlineCode",{parentName:"p"},"name/Doe/Eve/Jane"),"); in the former case, ",(0,r.yg)("inlineCode",{parentName:"p"},"$firstname === 'John'")," and in the latter case ",(0,r.yg)("inlineCode",{parentName:"p"},"$firstname === 'Jane'"),"."),(0,r.yg)("p",null,"The wild card symbol in Valve is the asterisk (the symbol ",(0,r.yg)("inlineCode",{parentName:"p"},"*"),") and ",(0,r.yg)("inlineCode",{parentName:"p"},"*")," matches every character until the end of the string. Placeholders start with a dollar\nsign followed by alphanumeric characters and match everything until a slash is encountered. In principle, identifiers can contain any character. Nevertheless,\nif you use an asterisk in an identifier, deepstream offers no way to match specifically this character."),(0,r.yg)("h3",{id:"expressions"},"Expressions"),(0,r.yg)("p",null,"After identifier matching, deepstream will evaluate the right-hand side expression. The expression can use a subset of JavaScript including"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"arithmetic expressions,"),(0,r.yg)("li",{parentName:"ul"},"the ",(0,r.yg)("a",{parentName:"li",href:"https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Operators/Conditional_Operator"},"conditional operator"),","),(0,r.yg)("li",{parentName:"ul"},"comparison operators,"),(0,r.yg)("li",{parentName:"ul"},"the string functions ",(0,r.yg)("inlineCode",{parentName:"li"},"startsWith"),", ",(0,r.yg)("inlineCode",{parentName:"li"},"endsWith"),", ",(0,r.yg)("inlineCode",{parentName:"li"},"indexOf"),", ",(0,r.yg)("inlineCode",{parentName:"li"},"match"),",\n",(0,r.yg)("inlineCode",{parentName:"li"},"toUpperCase"),", ",(0,r.yg)("inlineCode",{parentName:"li"},"toLowerCase"),", and ",(0,r.yg)("inlineCode",{parentName:"li"},"trim"),".")),(0,r.yg)("p",null,"Additionally, you can use the current time (on the server) with ",(0,r.yg)("inlineCode",{parentName:"p"},"now"),", you can access deepstream data, and cross-reference records."),(0,r.yg)("p",null,"Any deepstream client needs to log onto the server and the user data can be accessed with Valve but note that user's are not necessarily authenticated unless this is forbidden in the config. You can check for authenticated users with ",(0,r.yg)("inlineCode",{parentName:"p"},"user.isAuthenticated")," (the ternary operator ",(0,r.yg)("inlineCode",{parentName:"p"},"?:")," may prove useful when checking\nthis property). If a client authenticated, its user id can be accessed with ",(0,r.yg)("inlineCode",{parentName:"p"},"user.userId")," and its server data with ",(0,r.yg)("inlineCode",{parentName:"p"},"user.data"),".  Additionally, Valve allows\nyou to examine data associated with a rule, e.g., for a record, this means one can examine old and new value.  Since the data is dependent on the type (record,\nevent, or RPC, and so on), we will discuss this detail in the sections on the specific types."),(0,r.yg)("p",null,"Valve gives you the ability to cross reference data in your records. In your right-hand side expression, use the term ",(0,r.yg)("inlineCode",{parentName:"p"},"_(identifier)")," to access the record\nwith the given identifier, where ",(0,r.yg)("inlineCode",{parentName:"p"},"identifier")," is interpreted as a JavaScript expression returning a string, e.g., ",(0,r.yg)("inlineCode",{parentName:"p"},"_('family/' + $lastname)"),". The cross\nreferenced record must exist. Note that cross references ignore Valve permissions meaning you gain indirect read access irrespective of the Valve rules."),(0,r.yg)("p",null,"When evaluating expressions, you need to keep several pitfalls in mind. Using the current time with ",(0,r.yg)("inlineCode",{parentName:"p"},"now")," requires you to consider the usual ",(0,r.yg)("a",{parentName:"p",href:"http://infiniteundo.com/post/25326999628/falsehoods-programmers-believe-about-time"},"limitations of\ntime-dependent operations")," on computers and additionally, ",(0,r.yg)("inlineCode",{parentName:"p"},"now")," is evaluated on the server; you should keep this in mind whenever a client uses the ",(0,r.yg)("em",{parentName:"p"},"current")," time in its code. Valve allows you to cross reference stored data but this is computationally expensive. Thus, the default config shipped with deepstream allows no more than three cross references as of December 21, 2016. Finally, the usual warnings about type coercion (implicit type conversions), ",(0,r.yg)("a",{parentName:"p",href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Comparison_Operators"},"JavaScript comparison operators"),", and ",(0,r.yg)("a",{parentName:"p",href:"http://www.w3schools.com/js/js_numbers.asp"},"floating-point arithmetic")," apply."),(0,r.yg)("h3",{id:"records"},"Records"),(0,r.yg)("p",null,"Records can be created, deleted, read from, written to, and you can ",(0,r.yg)("em",{parentName:"p"},"listen")," to other clients subscribing to records (the ",(0,r.yg)("a",{parentName:"p",href:"../datasync/records"},"record tutorial")," elaborates on these operations and it explains the differences between unsubscribing from, discarding, and deleting records). The following snippet is the default Valve code for records:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},'record:\n    "*":\n        create: true # client.record.getRecord()\n        read: true # client.record.getRecord(), record.get()\n        write: true # record.set()\n        listen: true # record.listen()\n        delete: false # record.delete()\n')),(0,r.yg)("p",null,"In Valve, you can access the current record contents by referencing ",(0,r.yg)("inlineCode",{parentName:"p"},"oldData")," and for the ",(0,r.yg)("inlineCode",{parentName:"p"},"write")," operation, the modified record can be examined with ",(0,r.yg)("inlineCode",{parentName:"p"},"data"),"."),(0,r.yg)("p",null,"Note that ",(0,r.yg)("inlineCode",{parentName:"p"},"create")," permissions are only invoked by ",(0,r.yg)("inlineCode",{parentName:"p"},"getRecord()")," if the requested record does not exist, otherwise only reading rights are required.\nSimilarly, writes are always successful if the record does not have to be modified, e.g., modified and unmodified record are identical. Moreover, if a write operation is rejected by the server, then the client must handle the resulting error message; otherwise the client copy of the record will be out of sync with the server state. Finally, do not mix up the ",(0,r.yg)("inlineCode",{parentName:"p"},"path")," given to ",(0,r.yg)("inlineCode",{parentName:"p"},"record.get()")," and ",(0,r.yg)("inlineCode",{parentName:"p"},"record.set()")," with the record ",(0,r.yg)("em",{parentName:"p"},"identifier")," that is used by Valve."),(0,r.yg)("h3",{id:"user-presence"},"User Presence"),(0,r.yg)("p",null,"deepstream can notify you when authenticated users log in. The permissioning key is called ",(0,r.yg)("inlineCode",{parentName:"p"},"presence")," and the only option is to allow or disallow listening:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},'presence:\n    "*":\n        allow: true # client.subscribe()\n')),(0,r.yg)("h3",{id:"events"},"Events"),(0,r.yg)("p",null,(0,r.yg)("a",{parentName:"p",href:"../pubsub/events"},"Events")," can be published and subscribed to. Moreover, a client emitting events may listen to event subscriptions. The actions can be permissioned in the section ",(0,r.yg)("inlineCode",{parentName:"p"},"events"),":"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},'events:\n    "*":\n        publish: true # client.event.emit()\n        subscribe: true # client.event.subscribe()\n        listen: true # client.event.listen()\n')),(0,r.yg)("p",null,"The ",(0,r.yg)("inlineCode",{parentName:"p"},"publish")," action allows the examination of the data by referencing ",(0,r.yg)("inlineCode",{parentName:"p"},"data")," in the expression."),(0,r.yg)("h3",{id:"rpcs"},"RPCs"),(0,r.yg)("p",null,(0,r.yg)("a",{parentName:"p",href:"../request-response/rpc"},"Remote procedure calls")," can be provided or requested. The corresponding permissioning section is identified by the key ",(0,r.yg)("inlineCode",{parentName:"p"},"rpc"),":"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},'rpc:\n    "*":\n        provide: true # client.rpc.provide()\n        request: true # client.rpc.make()\n')),(0,r.yg)("h3",{id:"configuring-for-file-based-permissioning"},"Configuring for File-Based Permissioning"),(0,r.yg)("p",null,"To use file-based permissioning, the config file must contain the key ",(0,r.yg)("inlineCode",{parentName:"p"},"permission.type")," with the value ",(0,r.yg)("inlineCode",{parentName:"p"},"config"),". The name of the permissioning file must be provided in the deepstream config file under the key ",(0,r.yg)("inlineCode",{parentName:"p"},"permission.options.path")," and can be chosen arbitrarily. If a relative path is used to indicate its location, then this path uses the directory containing the config file as base directory."),(0,r.yg)("p",null,"In summary, if the permissioning rules can be found in ",(0,r.yg)("inlineCode",{parentName:"p"},"conf/permissions.yml")," and if the configuration file is ",(0,r.yg)("inlineCode",{parentName:"p"},"conf/config.yml"),", then a minimal config for\nfile-based permissioning looks as follows:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},"permission:\n    type: config\n    options:\n        path: ./permissions.yml\n")),(0,r.yg)("h2",{id:"further-reading"},"Further Reading"),(0,r.yg)("p",null,"More compact introductions (or refreshers) are the tutorials ",(0,r.yg)("a",{parentName:"p",href:"valve-simple"},(0,r.yg)("em",{parentName:"a"},"Valve Permissioning Simple")),", ",(0,r.yg)("a",{parentName:"p",href:"valve-advanced"},(0,r.yg)("em",{parentName:"a"},"Valve Permissioning Advanced")),", and ",(0,r.yg)("a",{parentName:"p",href:"valve-dynamic"},(0,r.yg)("em",{parentName:"a"},"Dynamic Permissions using Valve")),". To learn how to sent user-specific data using Valve, have a look at the ",(0,r.yg)("a",{parentName:"p",href:"user-specific-data"},"user-specific data guide"),"."))}c.isMDXComponent=!0},5680:(e,n,i)=>{i.d(n,{xA:()=>d,yg:()=>h});var t=i(6540);function r(e,n,i){return n in e?Object.defineProperty(e,n,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[n]=i,e}function a(e,n){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),i.push.apply(i,t)}return i}function s(e){for(var n=1;n<arguments.length;n++){var i=null!=arguments[n]?arguments[n]:{};n%2?a(Object(i),!0).forEach((function(n){r(e,n,i[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):a(Object(i)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(i,n))}))}return e}function o(e,n){if(null==e)return{};var i,t,r=function(e,n){if(null==e)return{};var i,t,r={},a=Object.keys(e);for(t=0;t<a.length;t++)i=a[t],n.indexOf(i)>=0||(r[i]=e[i]);return r}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(t=0;t<a.length;t++)i=a[t],n.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(r[i]=e[i])}return r}var l=t.createContext({}),p=function(e){var n=t.useContext(l),i=n;return e&&(i="function"==typeof e?e(n):s(s({},n),e)),i},d=function(e){var n=p(e.components);return t.createElement(l.Provider,{value:n},e.children)},c="mdxType",m={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},u=t.forwardRef((function(e,n){var i=e.components,r=e.mdxType,a=e.originalType,l=e.parentName,d=o(e,["components","mdxType","originalType","parentName"]),c=p(i),u=r,h=c["".concat(l,".").concat(u)]||c[u]||m[u]||a;return i?t.createElement(h,s(s({ref:n},d),{},{components:i})):t.createElement(h,s({ref:n},d))}));function h(e,n){var i=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var a=i.length,s=new Array(a);s[0]=u;var o={};for(var l in n)hasOwnProperty.call(n,l)&&(o[l]=n[l]);o.originalType=e,o[c]="string"==typeof e?e:r,s[1]=o;for(var p=2;p<a;p++)s[p]=i[p];return t.createElement.apply(null,s)}return t.createElement.apply(null,i)}u.displayName="MDXCreateElement"}}]);