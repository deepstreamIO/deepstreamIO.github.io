"use strict";(self.webpackChunkdeepstreamio_github_io=self.webpackChunkdeepstreamio_github_io||[]).push([[2800],{3905:function(e,t,n){n.d(t,{Zo:function(){return d},kt:function(){return f}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),c=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},d=function(e){var t=c(e.components);return a.createElement(s.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,d=o(e,["components","mdxType","originalType","parentName"]),h=c(n),f=r,g=h["".concat(s,".").concat(f)]||h[f]||p[f]||i;return n?a.createElement(g,l(l({ref:t},d),{},{components:n})):a.createElement(g,l({ref:t},d))}));function f(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,l=new Array(i);l[0]=h;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o.mdxType="string"==typeof e?e:r,l[1]=o;for(var c=2;c<i;c++)l[c]=n[c];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},4843:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return o},contentTitle:function(){return s},metadata:function(){return c},toc:function(){return d},default:function(){return h}});var a=n(7462),r=n(3366),i=(n(7294),n(3905)),l=["components"],o={title:"Realtime Flight Tracker",description:"Building a realtime flight tracker with deepstream",tags:["flights","web","realtime","records"]},s=void 0,c={unversionedId:"guides/example-apps/realtime-flight-tracker",id:"guides/example-apps/realtime-flight-tracker",title:"Realtime Flight Tracker",description:"Building a realtime flight tracker with deepstream",source:"@site/docs/20-guides/example-apps/realtime-flight-tracker.md",sourceDirName:"20-guides/example-apps",slug:"/guides/example-apps/realtime-flight-tracker",permalink:"/docs/guides/example-apps/realtime-flight-tracker",editUrl:"https://github.com/deepstreamIO/deepstreamIO.github.io/docs/20-guides/example-apps/realtime-flight-tracker.md",tags:[{label:"flights",permalink:"/docs/tags/flights"},{label:"web",permalink:"/docs/tags/web"},{label:"realtime",permalink:"/docs/tags/realtime"},{label:"records",permalink:"/docs/tags/records"}],version:"current",frontMatter:{title:"Realtime Flight Tracker",description:"Building a realtime flight tracker with deepstream",tags:["flights","web","realtime","records"]},sidebar:"tutorialSidebar",previous:{title:"Realtime Comment Feed",permalink:"/docs/guides/example-apps/realtime-comment-feed-using-vue"},next:{title:"Realtime friend locator",permalink:"/docs/guides/example-apps/realtime-friend-locator"}},d=[{value:"Realtime updates via provider",id:"realtime-updates-via-provider",children:[],level:2},{value:"Web front end",id:"web-front-end",children:[],level:2}],p={toc:d};function h(e){var t=e.components,o=(0,r.Z)(e,l);return(0,i.kt)("wrapper",(0,a.Z)({},p,o,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"This tutorial will take you through building a realtime flight tracking system with deepstream. We'll be building both a backend provider process that updates the records with the location of flights, and a web based front end that allows us to visualise these. If you'd like to dive straight into the code you can take a look at the GitHub ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/deepstreamIO/dsh-demo-realtime-flight-tracker"},"repository"),"."),(0,i.kt)("h2",{id:"realtime-updates-via-provider"},"Realtime updates via provider"),(0,i.kt)("p",null,"To provide these updates, we'll be polling an endpoint for the location of flights. Since the flights aren't necessarily updated every second, we'll be naively interpolating the data points to create a smoother experience for the end user."),(0,i.kt)("p",null,"The first thing we'll do is create our backend process that provides the realtime updates to our clients. The only dependencies we'll have for this provider will be the ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/deepstreamIO/deepstream.io-client-js"},"deepstream Javascript client")," and ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/tomas/needle"},"needle"),", a nice wrapper for making HTTP requests."),(0,i.kt)("p",null,"We can get a reference to our client as follows, and then get our deepstream ",(0,i.kt)("inlineCode",{parentName:"p"},"List")," of flights, this is the list of flights that clients will be referring to."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"const client = new DeepstreamClient('localhost:6020')\nclient.login({}, () => {\n  flightList = client.record.getList('flights')\n})\n")),(0,i.kt)("p",null,"Once we've logged in, we need to start polling our endpoint for flight data, we've put this into a function called ",(0,i.kt)("inlineCode",{parentName:"p"},"fetchFlightData"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"const fetchFlightData = () => {\n  needle.get(\n  'https://data-live.flightradar24.com/zones/fcgi/feed.js?bounds=52.74,52.19,12.91,13.74',\n  (err, resp) => {\n    for (const key in resp.body) {\n      // some keys contain metadata about the request, we're only concerned about\n      // ones that contain an Array of flight data\n      if (!(resp.body[key] instanceof Array)) continue\n      const [flightId, lat, lng] = resp.body[key]\n    }\n  })\n}\n")),(0,i.kt)("p",null,"From here it gets a bit tricky, since not all flights are updated every second, or even every five seconds, we need to have a buffer where we store interpolated data points. We have a function called ",(0,i.kt)("inlineCode",{parentName:"p"},"addToBuffer")," that does this, and it's a bit dense, so let's break it down."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},'const flights = new Map()\n\nconst addToBuffer = (flightId, lat, lng) => {\n  const flightName = `flights/${flightId}`\n  let flight = flights.get(flightName)\n  if (!flight) {\n    flight = {}\n    flight.record = client.record.getRecord(flightName)\n    // check if "flights" contains "flights/1234"\n    // if not, add it\n    if (flightList.getEntries().indexOf(flightName) === -1) {\n      flightList.addEntry(flightName)\n    }\n    flight.buffer = [{ lat, lng }]\n    flight.lastLocation = { lat, lng }\n    flights.set(flightName, flight)\n  }\n')),(0,i.kt)("p",null,"This part is quite straight forward, because we have a list called ",(0,i.kt)("inlineCode",{parentName:"p"},"flights"),", all our Record names will be prefixed by ",(0,i.kt)("inlineCode",{parentName:"p"},"flights/"),". We have a Map that is going to store various bits of data about the flight, such as the last location and buffer."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"  if (flight.lastLocation.lat == lat && flight.lastLocation.lng == lng ) {\n    return\n")),(0,i.kt)("p",null,"Here we're saying that if the location of the flight retrieved from our HTTP request is the same as it was before, don't do anything."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"  } else {\n    for (let i = 0; i < 50; i++) {\n      const newLat = lat - ((flight.lastLocation.lat - lat) / 50) * i\n      const newLng = lng - ((flight.lastLocation.lng - lng) / 50) * i\n      flight.buffer.push({ lat: newLat, lng: newLng })\n    }\n    flight.lastLocation = { lat, lng }\n  }\n}\n")),(0,i.kt)("p",null,"Finally, we have the interpolation step. Here we're creating 50 datapoints between the last known location, and the new one. We then push these into a buffer - we'll get to the buffer in a bit."),(0,i.kt)("p",null,"Now that we have this buffer, it's a simple matter of setting the Record at an interval with these coordinates. We use the ",(0,i.kt)("inlineCode",{parentName:"p"},"Array.shift()")," function to remove the first entry from the buffer. This way we're always updating the flights location in the correct direction."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"const updateLocations = () => {\n  for (const [flightName, flightData]  of flights) {\n    // flight is stationary\n    if (!flightData.buffer[0]) continue\n    flightData.record.set(\n      flightData.buffer.shift()\n    )\n  }\n}\n")),(0,i.kt)("p",null,"Now back at the start of our script we can put the following lines. This starts the fetching of flight data at an interval, and starts updating the Records in our flight list with the location of flights."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"setInterval(fetchFlightData, 1000)\nfetchFlightData()\nsetInterval(updateLocations, 100))\n")),(0,i.kt)("h2",{id:"web-front-end"},"Web front end"),(0,i.kt)("p",null,"Now that we have our backend process providing these location updates, we need a web interface to display these on. We'll be using the google maps API to display markers, and the deepstream Records to update the coordinates of these."),(0,i.kt)("p",null,"The first thing we need to do is initialise this map and our deepstream client. We can then get our list of flights and render it. We've left out the code for initialising the map, however if you're interested you can look at it in the GitHub repo."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"function init() {\n  map = new google.maps.Map(document.getElementById('map'), { ... })\n  client = new DeepstreamClient('localhost:6020')\n  client.login({}, (success) => {\n    const list = client.record.getList('flights')\n    list.whenReady(renderList)\n  })\n}\n")),(0,i.kt)("p",null,"Inside of our ",(0,i.kt)("inlineCode",{parentName:"p"},"renderList")," function, we're just adding listeners to list events, as well as calling our ",(0,i.kt)("inlineCode",{parentName:"p"},"addFlightTracking")," function on each entry."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"function renderList(list) {\n  list.getEntries().forEach(addFlightTracking)\n  list.on('entry-added', addFlightTracking)\n  list.on('entry-removed', removeFlightTracking)\n}\n")),(0,i.kt)("p",null,"The real work of our front end is inside this ",(0,i.kt)("inlineCode",{parentName:"p"},"addFlightTracking")," function. We create a marker and set the coordinates of it to whatever our Record data is. Our provider process will be sending objects in the form ",(0,i.kt)("inlineCode",{parentName:"p"},"{ lat: xxx, lng: yyy }"),". We then also subscribe to any future changes, updating the markers location in the event of these."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"function addFlightTracking(flightId) {\n  const record = client.record.getRecord(String(flightId))\n  const marker = new google.maps.Marker({ ... })\n\n  record.whenReady((record) => {\n    marker.setPosition(record.get())\n  })\n\n  record.subscribe((data) => {\n    marker.setPosition(data)\n  })\n\n  markers[flightId] = marker\n}\n")),(0,i.kt)("p",null,"After all this, we should have an application that looks as follows:"),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"flights",src:n(3888).Z})))}h.isMDXComponent=!0},3888:function(e,t,n){t.Z=n.p+"assets/images/flights-8be111fc2a590172f4788a4b04400728.gif"}}]);