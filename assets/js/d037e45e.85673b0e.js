"use strict";(self.webpackChunkdeepstreamio_github_io=self.webpackChunkdeepstreamio_github_io||[]).push([[9099],{3905:function(e,t,n){n.d(t,{Zo:function(){return d},kt:function(){return m}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},d=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},p=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),p=c(n),m=r,f=p["".concat(l,".").concat(m)]||p[m]||u[m]||i;return n?a.createElement(f,o(o({ref:t},d),{},{components:n})):a.createElement(f,o({ref:t},d))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=p;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var c=2;c<i;c++)o[c]=n[c];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}p.displayName="MDXCreateElement"},813:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return s},contentTitle:function(){return l},metadata:function(){return c},toc:function(){return d},default:function(){return p}});var a=n(7462),r=n(3366),i=(n(7294),n(3905)),o=["components"],s={title:"Valve Advanced",description:"Learn how to unlock the full potential of Valve"},l=void 0,c={unversionedId:"tutorials/core/permission/valve-advanced",id:"tutorials/core/permission/valve-advanced",title:"Valve Advanced",description:"Learn how to unlock the full potential of Valve",source:"@site/docs/00-tutorials/20-core/30-permission/30-valve-advanced.md",sourceDirName:"00-tutorials/20-core/30-permission",slug:"/tutorials/core/permission/valve-advanced",permalink:"/docs/tutorials/core/permission/valve-advanced",editUrl:"https://github.com/deepstreamIO/deepstreamIO.github.io/docs/00-tutorials/20-core/30-permission/30-valve-advanced.md",tags:[],version:"current",sidebarPosition:30,frontMatter:{title:"Valve Advanced",description:"Learn how to unlock the full potential of Valve"},sidebar:"tutorialSidebar",previous:{title:"Valve Simple",permalink:"/docs/tutorials/core/permission/valve-simple"},next:{title:"Valve Dynamic",permalink:"/docs/tutorials/core/permission/valve-dynamic"}},d=[{value:"Variables",id:"variables",children:[{value:"<code>data</code> &amp; <code>oldData</code>",id:"data--olddata",children:[],level:4},{value:"<code>user</code>",id:"user",children:[],level:4}],level:2},{value:"String Functions",id:"string-functions",children:[],level:2},{value:"Cross References",id:"cross-references",children:[{value:"Nesting cross-references",id:"nesting-cross-references",children:[],level:4},{value:"Performance implications of cross-references",id:"performance-implications-of-cross-references",children:[],level:4}],level:2}],u={toc:d};function p(e){var t=e.components,n=(0,r.Z)(e,o);return(0,i.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"Ok, time for some advanced valve rules. To get up to speed with the basics, head over to the ",(0,i.kt)("a",{parentName:"p",href:"valve-simple"},"simple permission rules example"),"."),(0,i.kt)("h2",{id:"variables"},"Variables"),(0,i.kt)("p",null,"Valve automatically injects a set of variables into its permission rules."),(0,i.kt)("h4",{id:"data--olddata"},(0,i.kt)("inlineCode",{parentName:"h4"},"data")," & ",(0,i.kt)("inlineCode",{parentName:"h4"},"oldData")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"data")," contains the data for events and RPCs. It can be used to validate the payload."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},'    # make sure a tweet contains max 140 characters\n    publish: "data.content.length < 140"\n    # make sure firstname is a string\n    write: "typeof data.firstname === \'string\'"\n')),(0,i.kt)("p",null,"For records, ",(0,i.kt)("inlineCode",{parentName:"p"},"data")," is the INCOMING data - the current data is available as ",(0,i.kt)("inlineCode",{parentName:"p"},"oldData"),". This is helpful for comparisons:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},'    # make sure bids at an auction can only go up\n    write: "data.price > oldData.price"\n    # make sure that `owner` can\'t be changed once written\n    write: "!data.owner || data.owner == oldData.owner"\n')),(0,i.kt)("h4",{id:"user"},(0,i.kt)("inlineCode",{parentName:"h4"},"user")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"user")," is an object containing information about the user attempting the action. It offers ",(0,i.kt)("inlineCode",{parentName:"p"},"user.id")," - the username that was provided at login and ",(0,i.kt)("inlineCode",{parentName:"p"},"user.data"),"."),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"user.data")," is the meta-data that was provided when the user logged in. This could be the data returned by the ",(0,i.kt)("a",{parentName:"p",href:"../auth/http-webhook"},"http webhook")," as ",(0,i.kt)("inlineCode",{parentName:"p"},"serverData")," or the ",(0,i.kt)("inlineCode",{parentName:"p"},"data")," field from the user file if you're using ",(0,i.kt)("a",{parentName:"p",href:"../auth/file"},"file-based authentication"),". Data is a great place to store authentication data like roles (e.g. ",(0,i.kt)("inlineCode",{parentName:"p"},"{role: 'admin'}"),"), access-levels or flags like ",(0,i.kt)("inlineCode",{parentName:"p"},"{ canDeletePosts: false }"),"."),(0,i.kt)("p",null,"Permissioning also allows age based validation in conjunction with ",(0,i.kt)("inlineCode",{parentName:"p"},"now"),", e.g., new users on a website may create new content and modify existing data only if\nmore than 24 hours passed since signing up:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},'record:\n    "*":\n        record: "user.data.timestamp + 24*60*60*1000 < now"\n        write: "user.data.timestamp + 24*60*60*1000 < now"\n')),(0,i.kt)("h2",{id:"string-functions"},"String Functions"),(0,i.kt)("p",null,"Valve supports a number of built-in string functions, namely ",(0,i.kt)("inlineCode",{parentName:"p"},"startsWith"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"endsWith"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"indexOf"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"match"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"toUpperCase"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"toLowerCase")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"trim"),". They can be useful to normalize and compare values, e.g."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"rpc:\n    book-purchase:\n        request: \"data.card.issuer.toLowerCase() == 'visa' && data.card.number.match(/^4[0-9]{12}(?:[0-9]{3})?$/)\"\n")),(0,i.kt)("h2",{id:"cross-references"},"Cross References"),(0,i.kt)("p",null,"Cross references allow you to reference data from other records within deepstream. This is an incredibly versatile feature, allowing you to check states or user-data, make sure that an item that's being purchased is still in stock or verify pre-conditions, e.g. making sure a user can only vote once. Cross references are written as ",(0,i.kt)("inlineCode",{parentName:"p"},"_(recordName)"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"make-call:\n    request: _('shop-status').isOpen == true\n")),(0,i.kt)("p",null,"Recordnames referrenced by the ",(0,i.kt)("inlineCode",{parentName:"p"},"_()")," function can also be dynamically created, e.g. from strings and path-variables."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"# Make sure an item is still in stock\npurchase/$itemId:\n    request: _('item/' + $itemId ).inStock > 0\n")),(0,i.kt)("h4",{id:"nesting-cross-references"},"Nesting cross-references"),(0,i.kt)("p",null,"It's even possible to nest cross references. Say we are running an online pharmacy and can only sell certain categories of drugs in countries they have clearance for. Here's the data we have to work with:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"// record drug/iqbxxluu-2lc9bl30t18\n{\n    name: 'Aprotinin',\n    categoryId: 'iqbxyw8u-1e686wg77xk'\n}\n\n// record category/iqbxyw8u-1e686wg77xk\n{\n    name: 'general Antifibrinolytics'\n    allowedCountries: [ 'FRA', 'SPA' ]\n}\n\n// user.data\n{\n    country: 'USA'\n}\n")),(0,i.kt)("p",null,"the rule below would now perform the following steps:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"load information about the drug the user is trying to purchase"),(0,i.kt)("li",{parentName:"ul"},"use the drug's ",(0,i.kt)("inlineCode",{parentName:"li"},"categoryId")," to load the category it belongs to"),(0,i.kt)("li",{parentName:"ul"},"check if the user's country is in the list of countries this drug's category can be sold in")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"# Make sure a drug's category is cleared for sale in the user's country\npurchase/$drugId:\n    request: _('category/' + _( 'drug/' + $drugId ).categoryId ).allowedCountries.indexOf( user.data.country ) > -1\n")),(0,i.kt)("p",null,"In this case the purchase attempt would be declined as the drug's category is only cleared for sale in France and Spain, but the user is from the US."),(0,i.kt)("h4",{id:"performance-implications-of-cross-references"},"Performance implications of cross-references"),(0,i.kt)("p",null,"Every cross-reference executes an additional query against deepstream's cache for every permissioning step - which will slow message transactions down. Nested cross references in particular are loaded one after another, so can lead to noticeable delays. You can specify a maximal depth for nested cross references as ",(0,i.kt)("inlineCode",{parentName:"p"},"maxRuleIterations: 3")," in deepstream's config file."))}p.isMDXComponent=!0}}]);