"use strict";(self.webpackChunkdeepstreamio_github_io=self.webpackChunkdeepstreamio_github_io||[]).push([[4121],{453:(e,t,a)=>{a.r(t),a.d(t,{contentTitle:()=>i,default:()=>d,frontMatter:()=>s,metadata:()=>l,toc:()=>u});var n=a(8168),r=(a(6540),a(5680)),o=a(5082);const s={title:"Storage Authentication",tags:["authentication","database","hash","crypto"]},i=void 0,l={unversionedId:"tutorials/core/auth/storage",id:"tutorials/core/auth/storage",title:"Storage Authentication",description:"Storage-based authentication allows you to store usernames, password hashes and optional meta-data in a table within your database that will be used to authenticate incoming connections.",source:"@site/docs/00-tutorials/20-core/20-auth/21-storage.mdx",sourceDirName:"00-tutorials/20-core/20-auth",slug:"/tutorials/core/auth/storage",permalink:"/docs/tutorials/core/auth/storage",editUrl:"https://github.com/deepstreamIO/deepstreamIO.github.io/docs/00-tutorials/20-core/20-auth/21-storage.mdx",tags:[{label:"authentication",permalink:"/docs/tags/authentication"},{label:"database",permalink:"/docs/tags/database"},{label:"hash",permalink:"/docs/tags/hash"},{label:"crypto",permalink:"/docs/tags/crypto"}],version:"current",sidebarPosition:21,frontMatter:{title:"Storage Authentication",tags:["authentication","database","hash","crypto"]},sidebar:"tutorialSidebar",previous:{title:"File Authentication",permalink:"/docs/tutorials/core/auth/file"},next:{title:"HTTP Authentication",permalink:"/docs/tutorials/core/auth/http-webhook"}},u=[{value:"Using Storage-based authentication",id:"using-storage-based-authentication",children:[],level:2},{value:"User auto-registration",id:"user-auto-registration",children:[],level:2},{value:"Don&#39;t forget to apply permissions",id:"dont-forget-to-apply-permissions",children:[],level:2}],c={toc:u},p="wrapper";function d(e){let{components:t,...a}=e;return(0,r.yg)(p,(0,n.A)({},c,a,{components:t,mdxType:"MDXLayout"}),(0,r.yg)("p",null,"Storage-based authentication allows you to store usernames, password hashes and optional meta-data in a table within your database that will be used to authenticate incoming connections."),(0,r.yg)("h2",{id:"using-storage-based-authentication"},"Using Storage-based authentication"),(0,r.yg)("p",null,"To enable authentication to a deepstream server with user credentials stored in your database, set the ",(0,r.yg)("inlineCode",{parentName:"p"},"type")," key to ",(0,r.yg)("inlineCode",{parentName:"p"},"storage")," in the ",(0,r.yg)("inlineCode",{parentName:"p"},"auth")," section of the server's ",(0,r.yg)("a",{parentName:"p",href:"../../../docs/server/configuration"},"configuration file"),"."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},"auth:\n  type: storage\n  options:\n    table: 'User' # The table to store the user data in\n    tableSplitChar: string # the split character used for tables (defaults to /)\n    createUser: true # automatically create users if they don't exist in the database\n    hash: 'md5' # the name of a HMAC digest algorithm\n    iterations: 100 # the number of times the algorithm should be applied\n    keyLength: 32 # the length of the resulting key\n    reportInvalidParameters: true # return when credentials are incorrect: missing username or password\n")),(0,r.yg)("p",null,"In the ",(0,r.yg)("inlineCode",{parentName:"p"},"hash")," key add the hashing algorithm to hash the passwords, for example, using ",(0,r.yg)("inlineCode",{parentName:"p"},"md5")," (or any other algorithm supported by your operating system). The ",(0,r.yg)("inlineCode",{parentName:"p"},"iterations")," key sets how many times the algorithm should be applied to the user's password, and ",(0,r.yg)("inlineCode",{parentName:"p"},"keyLength")," is the length of the generated key. These should match how you hashed the passwords."),(0,r.yg)("p",null,"Start the deepstream server and you should see the authentication type confirmed."),(0,r.yg)("p",null,"In your application code you can now connect to the deepstream server and try to login a user."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-javascript"},"import { DeepstreamClient } = from '@deepstream/client'\nconst client = new DeepstreamClient('localhost:6020')\n\nclient.login({\n  username: 'chris',\n  password: 'password' // NEEDS TO BE REAL\n})\n")),(0,r.yg)("p",null,"You can then handle the outcome of the login request in your JavaScript code, for example:"),(0,r.yg)(o.Ay,{mdxType:"JsLogin"}),(0,r.yg)("h2",{id:"user-auto-registration"},"User auto-registration"),(0,r.yg)("p",null,"If you set ",(0,r.yg)("inlineCode",{parentName:"p"},"createUser")," to true, deepstream will create a user for you automatically. This helps with\nworkflows where users can sign up to accounts without using a separate API."),(0,r.yg)("p",null,"If a user is created on their first login it's worth noting the following:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"ServerData is empty"),(0,r.yg)("li",{parentName:"ul"},"ClientData contains two fields:",(0,r.yg)("ul",{parentName:"li"},(0,r.yg)("li",{parentName:"ul"},"The timestamp for when the user was created"),(0,r.yg)("li",{parentName:"ul"},"The user id"))),(0,r.yg)("li",{parentName:"ul"},"The username within deepstream is actually the userId and not the username")),(0,r.yg)("p",null,"The assignment of an unique id for each user is extremely important for two reasons:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"It's used within presence, so whenever you do ",(0,r.yg)("inlineCode",{parentName:"li"},"client.presence.getAll()")," or ",(0,r.yg)("inlineCode",{parentName:"li"},"client.presence.subscribe()")," you will be interacting with the generated user id rather than the username"),(0,r.yg)("li",{parentName:"ul"},"It's used within permissions, so will be used when you access the user id via ",(0,r.yg)("inlineCode",{parentName:"li"},"user.id"))),(0,r.yg)("p",null,"So why use an id at all rather than the username? Because usernames are something people may want to change, but uuids last forever. This way you have the option of setting up your applications without having to update\nall the references within your database."),(0,r.yg)("h2",{id:"dont-forget-to-apply-permissions"},"Don't forget to apply permissions"),(0,r.yg)("p",null,"Seriously, please don't! Since the database is open by default this means that any user can request or update the data, which is a huge security issue."),(0,r.yg)("p",null,"The simplest way to add permissions is to just deny access to that table in Valve."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre"},"record:\n  'YourUserTable/.*':\n    create: false\n    write: false\n    read: false\n    delete: false\n    listen: false\n    notify: false\n")),(0,r.yg)("p",null,"So why not do internal magic to apply this automagically? Because if you apply your permissions correctly you can do some really cool stuff. For example, modifying the user data from an admin UI or deleting the user."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre"},'record:\n  "YourUserTable/.*":\n    write: "user.data.role === \'admin\'"\n    read: "user.data.role === \'admin\'"\n    delete: "user.data.role === \'admin\'"\n')),(0,r.yg)("p",null,"The users themselves shouldn't have access to the UserTable and do things via an RPC call in case of changing any of their data or password."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-javascript"},"import { DeepstreamClient } = from '@deepstream/client'\nconst client = new DeepstreamClient('localhost:6020')\n\nasync {\n  await client.login({ username: 'a user with an admin role', password: '1234' })\n\n  client.rpc.provide('change-user-details', async (data, response) => {\n    const user = client.record.snapshot(`User/${data.username}`)\n    // update user data\n    await client.record.setData(`User/${data.username}`, user)\n    response.send('Done')\n  })\n}\n")))}d.isMDXComponent=!0},5082:(e,t,a)=>{a.d(t,{Ay:()=>i});var n=a(8168),r=(a(6540),a(5680));const o={toc:[]},s="wrapper";function i(e){let{components:t,...a}=e;return(0,r.yg)(s,(0,n.A)({},o,a,{components:t,mdxType:"MDXLayout"}),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-js"},"// ES5\nconst { DeepstreamClient } = require('@deepstream/client')\nconst client = new DeepstreamClient('localhost:6020');\n\nclient.login({\n  username: 'chris',\n  password: 'password' // NEEDS TO BE REAL\n}, (success, clientData) => {\n  if (success) {\n    // Do stuff now your authenticated\n  } else {\n      // Unhappy path of an unsuccesful login\n  }\n})\n")),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-js"},"//ES6\nimport deepstream from '@deepstream/client'\nconst client = new DeepstreamClient('localhost:6020')\n\ntry {\n  const clientData = await client.login({\n    username: 'chris',\n    password: 'password' // NEEDS TO BE REAL\n  })\n  // Do stuff now your authenticated\n} catch (error) {\n  // Unhappy path of an unsuccesful login\n}\n")))}i.isMDXComponent=!0},5680:(e,t,a)=>{a.d(t,{xA:()=>c,yg:()=>g});var n=a(6540);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function s(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function i(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var l=n.createContext({}),u=function(e){var t=n.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):s(s({},t),e)),a},c=function(e){var t=u(e.components);return n.createElement(l.Provider,{value:t},e.children)},p="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},h=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),p=u(a),h=r,g=p["".concat(l,".").concat(h)]||p[h]||d[h]||o;return a?n.createElement(g,s(s({ref:t},c),{},{components:a})):n.createElement(g,s({ref:t},c))}));function g(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=a.length,s=new Array(o);s[0]=h;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i[p]="string"==typeof e?e:r,s[1]=i;for(var u=2;u<o;u++)s[u]=a[u];return n.createElement.apply(null,s)}return n.createElement.apply(null,a)}h.displayName="MDXCreateElement"}}]);